name: CI/CD Pipeline

on:
  push:
    branches: [develop, main]
  pull_request:
    branches: [develop]

jobs:
  lint-test-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Lint with flake8
        run: |
          pip install flake8
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics

      - name: Run Django tests
        env:
          SECRET_KEY: fake-secret-key
          DEBUG: "False"
          DB_HOST: localhost
          POSTGRES_DB: testdb
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          REDIS_URL: redis://localhost:6379/0
        run: |
          docker run -d --name postgres-test -e POSTGRES_DB=testdb -e POSTGRES_USER=testuser -e POSTGRES_PASSWORD=testpass -p 5432:5432 postgres:15
          docker run -d --name redis-test -p 6379:6379 redis:7-alpine
          sleep 10
          python manage.py test --settings=DjREST.settings
          docker stop postgres-test redis-test
          docker rm postgres-test redis-test

      - name: Build Docker images
        run: docker build -t djrest:latest .

  deploy:
    needs: lint-test-build
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/deploy/djrest
            git pull origin develop
            docker compose down
            docker compose pull
            docker compose up -d --build
            echo "âœ… Deployment completed"
